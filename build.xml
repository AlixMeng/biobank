<?xml version="1.0" encoding="UTF-8"?>
<project name="biobank2" basedir="." default="sdk">

<!--
  Overall build file

  use command "ant -projecthelp" to display the targets.

-->

<property environment="env"/>
<property name="cacore.sdk.dir" location="caCORE_SDK/sdk" />
<property name="eclipse.proj.dir" location="eclipse_ws/biobank2" />
<property name="eclipse.proj.dir.junit" location="eclipse_ws/biobank2.tests" />
<property name="scripts.proj.dir" location="scripts" /> <!--tp-->
<property name="model.proj.dir" location="model" /> <!--tp-->
<property name="data.dir" location="data" />
<property name="data.sql.dir" location="${data.dir}/sql" />
<property name="schema.dir" location="schema" />
<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver" />
<property name="database.host" value="localhost" />
<property name="database.port" value="3306" />
<property name="database.name" value="biobank2" />
<property name="database.username" value="dummy" />
<property name="database.password" value="ozzy498" />

<target name="sdk"
        description="builds the caCORE SDK from the data model" >
  <copy
     file="sdk_conf/deploy.properties"
     tofile="${cacore.sdk.dir}/conf/deploy.properties"/>
  <ant
     dir="${cacore.sdk.dir}"
     target="build-system"
     inheritRefs="false" />
</target>

<target name="deploy-eclipse"
        description="deploys the caCORE SDK beans to the eclipse project"
        depends="sdk">
  <copy todir="${eclipse.proj.dir}/lib">
    <fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" />
  </copy>
  <copy todir="${eclipse.proj.dir}/conf">
    <fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/conf">
      <include name="application-config-client*.xml" />
    </fileset>
  </copy>
  <copy
     file="${cacore.sdk.dir}/output/biobank2/src/hibernate.cfg.xml"
     tofile="${eclipse.proj.dir}/lib"/>

  <copy todir="${eclipse.proj.dir.junit}/lib">
    <fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" />
  </copy>
  <copy todir="${eclipse.proj.dir.junit}/conf">
     <fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/conf">
       <include name="application-config-client*.xml" />
     </fileset>
   </copy>
</target>

<target name="deploy-jboss"
        description="deploys the caCORE SDK webapp to JBoss">
  <fail unless="env.JBOSS_HOME" message="$JBOSS_HOME not defined" />
  <antcall target="sdk" />
  <copy
     file="${cacore.sdk.dir}/output/biobank2/package/webapp/biobank2.war"
     tofile="${env.JBOSS_HOME}/server/default/deploy/biobank2.war"/>
</target>

<target
   name="deploy"
   description="deploys to JBoss and Eclipse project">
  <antcall target="deploy-jboss" />
  <antcall target="deploy-eclipse" />
</target>

<target name="schema"
        description="generates the database schema for the caCORE SDK data model">
<!--        depends="sdk">-->
  <ant
     dir="${schema.dir}"
     target="schemaexport"
     inheritRefs="false" />
</target>

<target name="dbcreate">
  <antcall target="schema" />
  <sql driver="${mysql.driver.string}"
        url="jdbc:mysql://${database.host}:${database.port}/${database.name}"
        userid="${database.username}" password="${database.password}" >
    <transaction src="${data.sql.dir}/sampleTypes.sql" />
    <transaction src="${data.sql.dir}/sdataTypes.sql" />
    <transaction>commit;</transaction>
    <classpath>
      <fileset dir="${cacore.sdk.dir}/system/lib">
	<include name="*.jar" />
      </fileset>
    </classpath>
  </sql>
</target>

<!--Add the length="#" field into .hbm.xml, references the biobank.uml file for the VARCHAR(#) -->
<target name="string-length-field-addition" description="XXX">
  <exec executable="perl">
    <env key="PATH" path="${scripts.proj.dir}"/>
    <arg value="${scripts.proj.dir}/hbmstringlength.pl"/>
    <arg value="${model.proj.dir}/biobank2.uml"/>
    <arg value="${cacore.sdk.dir}/output/biobank2/src/edu/ualberta/med/biobank/model"/>
	<arg value="0"/><!--Verbose-->
  </exec>
</target>
<!--Add the length="#" field into .hbm.xml, references the biobank.uml file for the VARCHAR(#) -->


<target name="clean">
  <ant
     dir="${cacore.sdk.dir}"
     target="clean"
     inheritRefs="false" />
</target>




</project>
