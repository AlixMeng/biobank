<?xml version="1.0" encoding="UTF-8"?>
<project name="biobank2" basedir="." default="deploy">

	<!--
     Overall build file
     use command "ant -projecthelp" to display the targets.
    -->

	<property environment="env" />
	<property name="host" value="aicml-med.cs.ualberta.ca" />
	<property name="${host}/" value="" />
	<property name="cacore.sdk.dir" location="caCORE_SDK/sdk" />
	<property name="cacore.sdk.filename" value="caCORE_SDK_411.tar.gz" />
	<property name="eclipse.proj.dir" location="eclipse_ws/biobank2" />
	<property name="eclipse.proj.dir.common" location="eclipse_ws/biobank.common" />
	<property name="eclipse.proj.dir.importer" location="eclipse_ws/biobank2.importer" />
	<property name="eclipse.proj.dir.junit" location="eclipse_ws/biobank2.tests" />
	<property name="scripts.proj.dir" location="scripts" />
	<!--tp-->
	<property name="model.proj.dir" location="model" />
	<!--tp-->
	<property name="data.dir" location="data" />
	<property name="data.sql.dir" location="${data.dir}/sql" />
	<property name="schema.dir" location="schema" />
	<property name="security.dir" location="security" />
	<property name="secu-log.dir" location="security-logs" />
	<property name="mysql.driver.string" value="com.mysql.jdbc.Driver" />
	<property name="database.host" value="localhost" />
	<property name="database.port" value="3306" />
	<property name="database.name" value="biobank2" />
	<property name="database.username" value="dummy" />
	<property name="database.password" value="ozzy498" />

	<condition property="perl" value="perl" else="/usr/bin/perl">
		<os family="windows" />
	</condition>

	<!--
     files included in the sdk build.xml - necessary to be sure that we have
     all the keys for the target we redefined
    -->
	<property file="${cacore.sdk.dir}/installer.properties" />
	<property file="${cacore.sdk.dir}/local.properties" />
	<property file="${cacore.sdk.dir}/conf/deploy.properties" />
	<property file="${cacore.sdk.dir}/build.properties" />
	<property file="${cacore.sdk.dir}/${codegen.dir}/build.properties" prefix="codegen" />
	<property file="${cacore.sdk.dir}/${codegen.validator.dir}/build.properties" prefix="validator" />
	<property file="${cacore.sdk.dir}/${system.dir}/build.properties" prefix="system" />
	<property file="${cacore.sdk.dir}/${writable-api.dir}/build.properties" prefix="writable-api" />
	<property file="${cacore.sdk.dir}/${security.dir}/build.properties" prefix="security" />
	<property file="${cacore.sdk.dir}/${grid-remoting.dir}/build.properties" prefix="grid-remoting" />
	<property file="${cacore.sdk.dir}/${grid-jaas.dir}/build.properties" prefix="grid-jaas" />

	<condition property="server-exclude-commons-logging" value="commons-logging*.*" else="">
		<equals arg1="${SERVER_TYPE}" arg2="jboss" casesensitive="false" trim="true" />
	</condition>
	<condition property="server-exclude-log4j" value="log4j*.*" else="">
		<equals arg1="${SERVER_TYPE}" arg2="jboss" casesensitive="false" trim="true" />
	</condition>
	<condition property="server-exclude-classes-list" value="**/log4j*.*" else="">
		<equals arg1="${SERVER_TYPE}" arg2="jboss" casesensitive="false" trim="true" />
	</condition>
	<condition property="WRITABLE_API_EXTENSION_ENABLED" value="true" else="false">
		<or>
			<equals arg1="${ENABLE_WRITABLE_API_EXTENSION}" arg2="true" casesensitive="false" trim="true" />
			<equals arg1="${ENABLE_WRITABLE_API_EXTENSION}" arg2="yes" casesensitive="false" trim="true" />
		</or>
	</condition>
	<condition property="read-api-exclude-list" value="" else="*.jar">
		<equals arg1="${WRITABLE_API_EXTENSION_ENABLED}" arg2="true" casesensitive="false" trim="true" />
	</condition>
	<condition property="SECURITY_ENABLED" value="true" else="false">
		<or>
			<equals arg1="${ENABLE_SECURITY}" arg2="true" casesensitive="false" trim="true" />
			<equals arg1="${ENABLE_SECURITY}" arg2="yes" casesensitive="false" trim="true" />
		</or>
	</condition>
	<!-- end of copied part -->

	<target name="check-jars-available">
		<available file="jars" type="dir" property="jars.available" />
	</target>

	<target name="jars-download" depends="check-jars-available" unless="jars.available" description="downloads required jars from the host machine">
		<mkdir dir="jars" />
		<echo message="downloading biobank jars..." />
		<exec executable="curl">
			<arg value="--silent" />
			<arg value="-obiobank_jars.tar.bz2" />
			<arg value="http://${host}/biobank_jars.tar.bz2" />
		</exec>
		<untar src="biobank_jars.tar.bz2" compression="bzip2" dest="." />
	</target>

	<target name="check-cacore-sdk-available">
		<available file="${cacore.sdk.dir}/build.xml" property="cacore.sdk.available" />
	</target>

	<target name="cacore-download" depends="check-cacore-sdk-available" unless="cacore.sdk.available" description="downloads caCORE SDK from the host machine">
		<mkdir dir="caCORE_SDK" />
		<echo message="downloading caCORE SDK..." />
		<exec executable="curl">
			<arg value="--silent" />
			<arg value="-o${cacore.sdk.filename}" />
			<arg value="http://${host}/${cacore.sdk.filename}" />
		</exec>
		<mkdir dir="${cacore.sdk.dir}" />
		<untar src="${cacore.sdk.filename}" compression="gzip" dest="${cacore.sdk.dir}" />
	</target>

	<target name="check-cacore-sdk-uptodate">
		<uptodate property="cacore.sdk.uptodate" targetfile="${cacore.sdk.dir}/output/biobank2">
			<srcfiles file="sdk_conf/deploy.properties" />
			<srcfiles file="model/biobank2.uml" />
		</uptodate>
	</target>

	<target name="sdk" depends="cacore-download,check-cacore-sdk-uptodate" unless="cacore.sdk.uptodate" description="builds the caCORE SDK from the data model">
		<copy file="sdk_conf/deploy.properties" tofile="${cacore.sdk.dir}/conf/deploy.properties" />
		<ant dir="${cacore.sdk.dir}" target="build-system" inheritRefs="false" />
	</target>

	<target name="sdk-files" depends="sdk">
		<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" id="sdk.jar.files">
			<include name="*.jar" />
		</fileset>

		<pathconvert pathsep="," property="sdk.jar.files.basename" refid="sdk.jar.files">
			<map from="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib/" to="" />
		</pathconvert>
	</target>

	<target name="deploy-eclipse" description="deploys the caCORE SDK beans to the eclipse project" depends="sdk-files">
		<dependset>
			<srcfilelist dir="${cacore.sdk.dir}/system/security/dist" files="sdk-security.jar" />
			<targetfilelist dir="${eclipse.proj.dir.common}/lib" files="sdk-security.jar" />
			<targetfilelist dir="${eclipse.proj.dir.importer}/lib" files="sdk-security.jar" />
			<targetfilelist dir="${eclipse.proj.dir.junit}/lib" files="sdk-security.jar" />
		</dependset>
		<dependset>
			<srcfilelist dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" files="${sdk.jar.files.basename}" />
			<targetfilelist dir="${eclipse.proj.dir.common}/lib" files="${sdk.jar.files.basename}" />
			<targetfilelist dir="${eclipse.proj.dir.importer}/lib" files="${sdk.jar.files.basename}" />
			<targetfilelist dir="${eclipse.proj.dir.junit}/lib" files="${sdk.jar.files.basename}" />
		</dependset>
		<copy todir="${eclipse.proj.dir.common}/lib" file="${cacore.sdk.dir}/system/security/dist/sdk-security.jar" />
		<copy todir="${eclipse.proj.dir.importer}/lib" file="${cacore.sdk.dir}/system/security/dist/sdk-security.jar" />
		<copy todir="${eclipse.proj.dir.junit}/lib" file="${cacore.sdk.dir}/system/security/dist/sdk-security.jar" />
		<copy todir="${eclipse.proj.dir.common}/lib">
			<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/conf">
				<include name="application-config-client*.xml" />
			</fileset>
		</copy>
		<copy todir="${eclipse.proj.dir.common}/lib">
			<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" />
		</copy>
		<copy todir="${eclipse.proj.dir.common}/lib">
			<fileset dir="${cacore.sdk.dir}/system/lib">
				<include name="commons-collections-3.2.jar" />
				<include name="commons-logging-1.1.jar" />
			</fileset>
			<fileset dir="jars">
				<include name="commons-lang-2.4.jar" />
			</fileset>
		</copy>
		<copy todir="${eclipse.proj.dir}/lib">
			<fileset dir="jars">
				<include name="org.eclipse.nebula.cwt_0.9.0.HEAD.jar" />
                <include name="org.eclipse.nebula.widgets.cdatetime_0.14.0.HEAD.jar" />
				<include name="gluegen.jar" />
				<include name="ini4j-0.5.1.jar" />
				<include name="jdom.jar" />
				<include name="scanlib.jar" />
			</fileset>
		</copy>
		<copy todir="${eclipse.proj.dir.importer}/lib">
			<fileset dir="${cacore.sdk.dir}/system/lib">
				<include name="commons-collections-3.2.jar" />
				<include name="commons-logging-1.1.jar" />
			</fileset>
			<fileset dir="jars">
				<include name="commons-lang-2.4.jar" />
				<include name="mysql-connector-java-5.1.7-bin.jar" />
			</fileset>
		</copy>
		<copy todir="${eclipse.proj.dir.importer}/lib">
			<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" />
		</copy>
		<copy todir="${eclipse.proj.dir.importer}/conf">
			<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/conf">
				<include name="application-config-client*.xml" />
			</fileset>
		</copy>

		<copy todir="${eclipse.proj.dir.junit}/lib">
			<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/lib" />
		</copy>
		<copy todir="${eclipse.proj.dir.junit}/conf">
			<fileset dir="${cacore.sdk.dir}/output/biobank2/package/remote-client/conf">
				<include name="application-config-client*.xml" />
			</fileset>
		</copy>
	</target>

	<target name="check-jboss-uptodate">
		<uptodate property="jboss.uptodate" targetfile="${env.JBOSS_HOME}/server/default/deploy/biobank2.war" srcfile="${cacore.sdk.dir}/output/biobank2/package/webapp/biobank2.war" />
	</target>

	<target name="deploy-jboss" depends="check-jboss-uptodate" description="deploys the caCORE SDK webapp to JBoss" unless="jboss.uptodate">
		<fail unless="env.JBOSS_HOME" message="$JBOSS_HOME not defined" />
		<copy file="${secu-log.dir}/jboss/login-config.xml" tofile="${env.JBOSS_HOME}/server/default/conf/login-config.xml" overwrite="true" />
		<delete file="${env.JBOSS_HOME}/server/default/deploy/mysql-ds.xml" />
		<!-- for compatibility: this file has been split -->
		<copy file="${secu-log.dir}/jboss/upt-ds.xml" tofile="${env.JBOSS_HOME}/server/default/deploy/upt-ds.xml" overwrite="true" />
		<copy file="${secu-log.dir}/jboss/upt.war" tofile="${env.JBOSS_HOME}/server/default/deploy/upt.war" overwrite="true" />
		<copy file="${secu-log.dir}/jboss/llt-ds.xml" tofile="${env.JBOSS_HOME}/server/default/deploy/llt-ds.xml" overwrite="true" />
		<copy file="${secu-log.dir}/jboss/llt.war" tofile="${env.JBOSS_HOME}/server/default/deploy/llt.war" overwrite="true" />

		<copy file="${cacore.sdk.dir}/output/biobank2/package/webapp/biobank2.war" tofile="${env.JBOSS_HOME}/server/default/deploy/biobank2.war" overwrite="true" />
	</target>

	<target name="deploy" description="deploys to JBoss and Eclipse project">
		<antcall target="jars-download" />
		<antcall target="deploy-eclipse" />
		<antcall target="deploy-jboss" />
	</target>

	<target name="schema" description="generates the database schema for the caCORE SDK data model">
		<ant dir="${schema.dir}" target="schemaexport" inheritRefs="false" />
	</target>

	<target name="dbcreate" description="creates the default tables">
		<antcall target="schema" />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
			<transaction src="${data.sql.dir}/pvInfoPossible.sql" />
			<transaction src="${data.sql.dir}/sampleSources.sql" />
			<transaction src="${data.sql.dir}/sampleTypes.sql" />
			<transaction src="${data.sql.dir}/containerLabelingScheme.sql" />
			<transaction src="${secu-log.dir}/schemaSecurityLogDump.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${cacore.sdk.dir}/system/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!--Add the length="#" field into .hbm.xml, references the biobank.uml file for the VARCHAR(#) -->
	<target name="string-length-field-addition" description="Add the length='#' field into .hbm.xml, references the biobank.uml file for the VARCHAR(#)" depends="check-cacore-sdk-uptodate" unless="cacore.sdk.uptodate">
		<exec executable="${perl}">
			<env key="PATH" path="${scripts.proj.dir}" />
			<arg value="${scripts.proj.dir}/hbmstringlength.pl" />
			<arg value="${model.proj.dir}/biobank2.uml" />
			<arg value="${cacore.sdk.dir}/output/biobank2/src/edu/ualberta/med/biobank/model" />
			<arg value="0" />
			<!--Verbose-->
		</exec>
	</target>

	<target name="package-codegen-orm" description="REDO:: Packages the generated ORM and bean artifacts" depends="string-length-field-addition">
		<jar destfile="${cacore.sdk.dir}\${build.jar.dir}\${orm.file}" basedir="${cacore.sdk.dir}\${output.src.dir}">
			<manifest>
				<attribute name="Generated-By" value="caCORE SDK Code Generator" />
				<attribute name="Version" value="${VERSION}" />
			</manifest>
			<include name="**/*.hbm.xml" />
			<include name="*.cfg.xml" />
			<include name="ehcache.xml" />
			<exclude name="${csm.security.config.file}" />
		</jar>
	</target>

	<!-- copied from sdk build.xml -->
	<target name="package-webapp-orm" depends="package-codegen-orm">
		<war destfile="${cacore.sdk.dir}\${package.system.dir}\${PROJECT_NAME}.war" webxml="${cacore.sdk.dir}\${build.conf.web-inf.dir}\web.xml">
			<manifest>
				<attribute name="Generated-By" value="biobank2 caCORE SDK Code Generator" />
				<attribute name="Version" value="${VERSION}" />
			</manifest>
			<lib dir="${cacore.sdk.dir}\${system.dir}\${system.dist.dir}" includes="*.jar" />
			<lib dir="${cacore.sdk.dir}\${writable-api.dir}\${writable-api.dist.dir}" includes="*.jar">
				<exclude name="${read-api-exclude-list}" />
			</lib>
			<lib dir="${cacore.sdk.dir}\${build.jar.dir}" includes="${bean.file}" />
			<lib dir="${cacore.sdk.dir}\${build.jar.dir}" includes="${orm.file}" />
			<lib dir="${cacore.sdk.dir}\${system.dir}\${system.lib.dir}" includes="*.jar">
				<exclude name="${server-exclude-commons-logging}" />
				<exclude name="${server-exclude-log4j}" />
				<exclude name="servlet.jar" />
				<exclude name="xercesImpl*.*" />
				<exclude name="cog*.*" />
			</lib>
			<lib dir="${cacore.sdk.dir}\${grid-jaas.dir}\${grid-jaas.dist.dir}" includes="*.*" excludes="${grid-jaas.file.output.jaas.jndibinder.name}" />
			<fileset dir="${cacore.sdk.dir}\${build.conf.system.web.dir}">
				<include name="**/*" />
				<exclude name="**/web.xml" />
				<exclude name="${server-exclude-classes-list}" />
			</fileset>
			<fileset dir="${cacore.sdk.dir}\${system.dir}\${system.web.dir}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${cacore.sdk.dir}\${build.dir}">
				<include name="docs/**/*" />
			</fileset>
			<classes dir="${cacore.sdk.dir}\${output.src.dir}">
				<include name="${csm.security.config.file}" />
				<include name="${csm.ehcache.file}" />
				<include name="${clm.object.state.logger.config}" />
			</classes>
			<webinf dir="${cacore.sdk.dir}\${output.src.dir}">
				<include name="server-config.wsdd" />
			</webinf>
		</war>
	</target>

	<target name="clean-jars" description="deletes jars from eclipse projects">
		<delete>
			<fileset dir="${eclipse.proj.dir}/lib" includes="**/*.jar" />
			<fileset dir="${eclipse.proj.dir.common}/lib" includes="**/*.jar" />
			<fileset dir="${eclipse.proj.dir.importer}/lib" includes="**/*.jar" />
			<fileset dir="${eclipse.proj.dir.junit}/lib" includes="**/*.jar" />
		</delete>
	</target>

	<target name="clean" description="cleans caCORE SDK and deletes jars from eclipse projects">
		<ant dir="${cacore.sdk.dir}" target="clean" inheritRefs="false" />
		<ant target="clean-jars" />
	</target>

</project>
