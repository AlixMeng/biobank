#!/bin/bash

#
# This script configures a Biobank server deployment.
#
#

# TODO:
# 1. modify console passwords

if [[ ! -d "$HOME/jboss-4.0.5.GA" ]]; then
   echo "Error: JBoss directory not found in home directory."
   exit 1
fi

BIOBANK_WAR="$HOME/jboss-4.0.5.GA/server/default/deploy/biobank.war"

if [[ ! -f "$BIOBANK_WAR" ]]; then
   echo "Error: server WAR file not found: $BIOBANK_WAR."
   exit 1
fi

ZIP="/usr/bin/zip"
UNZIP="/usr/bin/unzip"
SED="/bin/sed"
DFLT_DBHOST="localhost"
DFLT_DBNAME="biobank"
DFLT_DB_DRIVER="com.mysql.jdbc.Driver"

TEMPLATES=(
    application-config.xml.template
    biobank-ds.xml.template
    login-config.xml.template
    log4j.xml.template
    upt-ds.xml.template
    V1__Base_version.sql.template)

read -p "Enter host name for MySQL server: [$DFLT_DBHOST] " DBHOST
DBHOST=${DBHOST:-$DFLT_DBHOST}

read -p "Enter database name for the Biobank application: [$DFLT_DBNAME] " DBNAME
DBNAME=${DBNAME:-$DFLT_DBNAME}

read -p "Enter user name for MySQL server: " DBUSER

read -s -p "Enter user's password: " DBPWD
echo ""

DBURL="jdbc:mysql:\/\/$DBHOST:3306\/$DBNAME"

BIOBANK_WAR_UNZIP_DIR=biobank_war

mkdir -p $BIOBANK_WAR_UNZIP_DIR
unzip -o $BIOBANK_WAR -d $BIOBANK_WAR_UNZIP_DIR &> /dev/null

for f in "${TEMPLATES[@]}"
do
    if [ ! -e "templates/$f" ]; then
        echo "ERROR: file is missing: $f"
        exit 0
    fi


   case $f in
       application-config.xml.template)
           DEST=biobank_war/WEB-INF/classes/application-config.xml
           ;;
       log4j.xml.template)
           DEST=biobank_war/WEB-INF/classes/log4j.xml
           ;;
       V1__Base_version.sql.template)
           DEST=biobank_war/db/migration/V1__Base_version.sql
           ;;
       biobank-ds.xml.template)
           DEST=$HOME/jboss-4.0.5.GA/server/default/deploy/biobank-ds.xml
           ;;
       login-config.xml.template)
           DEST=$HOME/jboss-4.0.5.GA/server/default/conf/login-config.xml
           ;;
       upt-ds.xml.template)
           DEST=$HOME/jboss-4.0.5.GA/server/default/deploy/upt-ds.xml
           ;;
   esac

   $SED "s/@database.driver@/$DFLT_DB_DRIVER/g;s/@database.url@/$DBURL/g;s/@database.username@/$DBUSER/g;s/@database.password@/$DBPWD/g" "templates/$f" > "$DEST"

done

cd $BIOBANK_WAR_UNZIP_DIR && zip -r $BIOBANK_WAR . &> /dev/null
cd ..
rm -rf $BIOBANK_WAR_UNZIP_DIR

echo "Biobank server is now ready to start"
