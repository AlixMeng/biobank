-- Biobank database upgrade script for version 3.2.1 to 3.3.0.

ALTER TABLE membership
      DROP FOREIGN KEY FKCD0773D692FAA705,
      DROP FOREIGN KEY FKCD0773D6F2A2464F;

ALTER TABLE membership
      DROP INDEX FKCD0773D692FAA705,
      DROP INDEX FKCD0773D6F2A2464F,
      DROP COLUMN STUDY_ID,
      DROP COLUMN CENTER_ID;

ALTER TABLE comment
      MODIFY COLUMN CREATED_AT DATETIME NOT NULL;

ALTER TABLE processing_event
      ADD COLUMN PROCESSED_BY VARCHAR(63) CHARACTER SET latin1
          COLLATE latin1_general_cs NULL DEFAULT NULL COMMENT '',
      ADD COLUMN PERSON_USER_ID INT(11) NULL DEFAULT NULL COMMENT '',
      ADD INDEX FK327B1E4E21C4671B (PERSON_USER_ID);

ALTER TABLE processing_event
      ADD CONSTRAINT FK327B1E4E21C4671B FOREIGN KEY FK327B1E4E21C4671B (PERSON_USER_ID)
          REFERENCES principal (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE specimen
      ADD COLUMN PLATE_ERRORS VARCHAR(100) CHARACTER SET latin1
          COLLATE latin1_general_cs NULL DEFAULT NULL COMMENT '',
      ADD COLUMN SAMPLE_ERRORS VARCHAR(100) CHARACTER SET latin1
          COLLATE latin1_general_cs NULL DEFAULT NULL COMMENT '';


CREATE TABLE file_meta_data (
    ID INT(11) NOT NULL,
    VERSION INT(11) NOT NULL,
    CONTENT_TYPE VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    CREATED_AT DATETIME NOT NULL,
    DESCRIPTION VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NULL DEFAULT NULL,
    MD5_HASH BINARY(16) NOT NULL,
    NAME VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    SHA1_HASH BINARY(20) NOT NULL,
    SIZE BIGINT(20) NOT NULL,
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

CREATE TABLE file_data (
    ID INT(11) NOT NULL,
    VERSION INT(11) NOT NULL,
    COMPRESSED_BYTES LONGBLOB NOT NULL,
    COMPRESSED_SIZE BIGINT(20) NOT NULL,
    FILE_META_DATA_ID INT(11) NOT NULL,
    CONSTRAINT FILE_META_DATA_ID UNIQUE KEY(FILE_META_DATA_ID),
    INDEX FK595EC08DA965B18F (FILE_META_DATA_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE file_data
      ADD CONSTRAINT FK595EC08DA965B18F FOREIGN KEY (FILE_META_DATA_ID)
          REFERENCES file_meta_data (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE batch_operation (
    ID INT(11) NOT NULL,
    VERSION INT(11) NOT NULL,
    TIME_EXECUTED DATETIME NOT NULL,
    EXECUTED_BY_USER_ID INT(11) NOT NULL,
    FILE_DATA_ID INT(11) NULL DEFAULT NULL,
    PRIMARY KEY (ID),
    INDEX FK5B242662F55E67FE (FILE_DATA_ID),
    INDEX FK5B242662FB2C14CD (EXECUTED_BY_USER_ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE batch_operation
      ADD CONSTRAINT FK5B242662FB2C14CD FOREIGN KEY (EXECUTED_BY_USER_ID)
          REFERENCES principal (ID) ON UPDATE NO ACTION ON DELETE NO ACTION,
      ADD CONSTRAINT FK5B242662F55E67FE FOREIGN KEY FK5B242662F55E67FE (FILE_DATA_ID)
          REFERENCES file_data (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE batch_operation_processing_event (
    PROCESSING_EVENT_ID INT(11) NOT NULL,
    BATCH_OPERATION_ID INT(11) NOT NULL,
    INDEX FKDA49AA8BD3BA0590 (BATCH_OPERATION_ID),
    PRIMARY KEY (PROCESSING_EVENT_ID, BATCH_OPERATION_ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE batch_operation_processing_event
      ADD CONSTRAINT FKDA49AA8BD3BA0590 FOREIGN KEY (BATCH_OPERATION_ID)
          REFERENCES batch_operation (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE batch_operation_specimen (
    SPECIMEN_ID INT(11) NOT NULL,
    BATCH_OPERATION_ID INT(11) NOT NULL,
    INDEX FKD2E0C45D3BA0590 (BATCH_OPERATION_ID),
    PRIMARY KEY (SPECIMEN_ID, BATCH_OPERATION_ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE batch_operation_specimen
      ADD CONSTRAINT FKD2E0C45D3BA0590 FOREIGN KEY (BATCH_OPERATION_ID)
          REFERENCES batch_operation (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE hibernate_sequences (
    sequence_name VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    next_val BIGINT(20) NULL DEFAULT NULL,
    PRIMARY KEY (sequence_name)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

CREATE TABLE revision (
    ID INT(11) NOT NULL,
    CREATED_AT DATETIME NULL DEFAULT NULL,
    USER_ID INT(11) NULL DEFAULT NULL,
    INDEX FK1F1AA7DBB9634A05 (USER_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE revision ADD CONSTRAINT FK1F1AA7DBB9634A05
      FOREIGN KEY (USER_ID) REFERENCES principal (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

INSERT INTO revision (id) VALUES (0);

CREATE TABLE revision_entity_type (
    ID INT(11) NOT NULL,
    TYPE VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    REVISION_ID INT(11) NOT NULL,
    INDEX FK74D6F3B29D2D0285 (REVISION_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE revision_entity_type
      ADD CONSTRAINT FK74D6F3B29D2D0285 FOREIGN KEY (REVISION_ID)
      REFERENCES revision (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

