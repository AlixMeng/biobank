-- Biobank database upgrade script for version 3.2.1 to 3.3.0.

ALTER TABLE membership
      DROP FOREIGN KEY FKCD0773D692FAA705,
      DROP FOREIGN KEY FKCD0773D6F2A2464F;

ALTER TABLE membership
      DROP INDEX FKCD0773D692FAA705,
      DROP INDEX FKCD0773D6F2A2464F,
      DROP COLUMN STUDY_ID,
      DROP COLUMN CENTER_ID;

ALTER TABLE comment
      MODIFY COLUMN CREATED_AT DATETIME NOT NULL;

ALTER TABLE processing_event
      ADD COLUMN PROCESSED_BY VARCHAR(63) CHARACTER SET latin1
          COLLATE latin1_general_cs NULL DEFAULT NULL COMMENT '',
      ADD COLUMN PERSON_USER_ID INT(11) NULL DEFAULT NULL COMMENT '',
      ADD INDEX FK327B1E4E21C4671B (PERSON_USER_ID);

ALTER TABLE processing_event
      ADD CONSTRAINT FK327B1E4E21C4671B FOREIGN KEY FK327B1E4E21C4671B (PERSON_USER_ID)
          REFERENCES principal (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE specimen
      ADD COLUMN PLATE_ERRORS VARCHAR(100) CHARACTER SET latin1
          COLLATE latin1_general_cs NULL DEFAULT NULL COMMENT '',
      ADD COLUMN SAMPLE_ERRORS VARCHAR(100) CHARACTER SET latin1
          COLLATE latin1_general_cs NULL DEFAULT NULL COMMENT '';

CREATE TABLE attachment (
    ID INT(11) NOT NULL,
    VERSION INT(11) NOT NULL,
    CONTENT_TYPE VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    DESCRIPTION VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NULL DEFAULT NULL,
    FILE_NAME VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    INSERTED_BY_USER_ID TINYBLOB NOT NULL,
    MD5_HASH BINARY(16) NOT NULL,
    SHA1_HASH BINARY(20) NOT NULL,
    SIZE BIGINT(20) NOT NULL,
    TIME_INSERTED DATETIME NOT NULL,
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

CREATE TABLE attachment_data (
    ID INT(11) NOT NULL,
    VERSION INT(11) NOT NULL,
    BYTES LONGBLOB NOT NULL,
    ATTACHMENT_ID INT(11) NOT NULL,
    CONSTRAINT ATTACHMENT_ID UNIQUE KEY(ATTACHMENT_ID),
    INDEX FK1C36194696F01EC5 (ATTACHMENT_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE attachment_data
      ADD CONSTRAINT FK1C36194696F01EC5 FOREIGN KEY (ATTACHMENT_ID)
          REFERENCES attachment (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE batch_operation (
    ID INT(11) NOT NULL,
    VERSION INT(11) NOT NULL,
    action TINYBLOB NOT NULL,
    inputType TINYBLOB NOT NULL,
    EXECUTED_BY_USER_ID INT(11) NOT NULL,
    INPUT_ATTACHMENT_ID INT(11) NULL DEFAULT NULL,
    INDEX FK5B2426625336DF10 (INPUT_ATTACHMENT_ID),
    INDEX FK5B242662FB2C14CD (EXECUTED_BY_USER_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE batch_operation
      ADD CONSTRAINT FK5B242662FB2C14CD FOREIGN KEY (EXECUTED_BY_USER_ID)
          REFERENCES principal (ID) ON UPDATE NO ACTION ON DELETE NO ACTION,
      ADD CONSTRAINT FK5B2426625336DF10 FOREIGN KEY (INPUT_ATTACHMENT_ID)
          REFERENCES attachment (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE batch_operation_processing_event (
    PROCESSING_EVENT_ID INT(11) NOT NULL,
    BATCH_OPERATION_ID INT(11) NOT NULL,
    INDEX FKDA49AA8BD3BA0590 (BATCH_OPERATION_ID),
    PRIMARY KEY (PROCESSING_EVENT_ID, BATCH_OPERATION_ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE batch_operation_processing_event
      ADD CONSTRAINT FKDA49AA8BD3BA0590 FOREIGN KEY (BATCH_OPERATION_ID)
          REFERENCES batch_operation (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE batch_operation_specimen (
    SPECIMEN_ID INT(11) NOT NULL,
    BATCH_OPERATION_ID INT(11) NOT NULL,
    INDEX FKD2E0C45D3BA0590 (BATCH_OPERATION_ID),
    PRIMARY KEY (SPECIMEN_ID, BATCH_OPERATION_ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE batch_operation_specimen
      ADD CONSTRAINT FKD2E0C45D3BA0590 FOREIGN KEY (BATCH_OPERATION_ID)
          REFERENCES batch_operation (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE revision (
    ID INT(11) NOT NULL,
    CREATED_AT DATETIME NULL DEFAULT NULL,
    USER_ID INT(11) NULL DEFAULT NULL,
    INDEX FK1F1AA7DBB9634A05 (USER_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE revision ADD CONSTRAINT FK1F1AA7DBB9634A05
      FOREIGN KEY (USER_ID) REFERENCES principal (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

INSERT INTO revision (id) VALUES (0);

CREATE TABLE revision_entity_type (
    ID INT(11) NOT NULL,
    TYPE VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NOT NULL,
    REVISION_ID INT(11) NOT NULL,
    INDEX FK74D6F3B29D2D0285 (REVISION_ID),
    PRIMARY KEY (ID)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE revision_entity_type
      ADD CONSTRAINT FK74D6F3B29D2D0285 FOREIGN KEY (REVISION_ID)
      REFERENCES revision (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE specimen_audit (
    ID INT(11) NOT NULL,
    REVISION INT(11) NOT NULL,
    REVISION_TYPE TINYINT(4) NULL DEFAULT NULL,
    END_REVISION INT(11) NULL DEFAULT NULL,
    ACTIVITY_STATUS_ID INT(11) NULL DEFAULT NULL,
    CREATED_AT DATETIME NULL DEFAULT NULL,
    INVENTORY_ID VARCHAR(100) CHARACTER SET latin1 COLLATE latin1_general_cs NULL DEFAULT NULL,
    PLATE_ERRORS VARCHAR(100) CHARACTER SET latin1 COLLATE latin1_general_cs NULL DEFAULT NULL,
    QUANTITY DECIMAL(20, 10) NULL DEFAULT NULL,
    SAMPLE_ERRORS VARCHAR(100) CHARACTER SET latin1 COLLATE latin1_general_cs NULL DEFAULT NULL,
    COLLECTION_EVENT_ID INT(11) NULL DEFAULT NULL,
    CURRENT_CENTER_ID INT(11) NULL DEFAULT NULL,
    ORIGIN_INFO_ID INT(11) NULL DEFAULT NULL,
    ORIGINAL_COLLECTION_EVENT_ID INT(11) NULL DEFAULT NULL,
    PARENT_SPECIMEN_ID INT(11) NULL DEFAULT NULL,
    PROCESSING_EVENT_ID INT(11) NULL DEFAULT NULL,
    SPECIMEN_TYPE_ID INT(11) NULL DEFAULT NULL,
    TOP_SPECIMEN_ID INT(11) NULL DEFAULT NULL,
    INDEX FKD59E8BE4E4714145 (END_REVISION),
    INDEX FKD59E8BE46F00D261 (REVISION),
    PRIMARY KEY (ID, REVISION)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE specimen_audit
      ADD CONSTRAINT FKD59E8BE46F00D261 FOREIGN KEY (REVISION)
          REFERENCES revision (ID) ON UPDATE NO ACTION ON DELETE NO ACTION,
      ADD CONSTRAINT FKD59E8BE4E4714145 FOREIGN KEY (END_REVISION)
          REFERENCES revision (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

INSERT INTO specimen_audit (id,revision,revision_type,ACTIVITY_STATUS_ID,CREATED_AT,
       INVENTORY_ID,PLATE_ERRORS,QUANTITY,SAMPLE_ERRORS,COLLECTION_EVENT_ID,
       CURRENT_CENTER_ID,ORIGIN_INFO_ID,ORIGINAL_COLLECTION_EVENT_ID,PARENT_SPECIMEN_ID,
       PROCESSING_EVENT_ID,SPECIMEN_TYPE_ID,TOP_SPECIMEN_ID)
       SELECT id,0,0,ACTIVITY_STATUS_ID,CREATED_AT,INVENTORY_ID,PLATE_ERRORS,QUANTITY,
              SAMPLE_ERRORS,COLLECTION_EVENT_ID,CURRENT_CENTER_ID,ORIGIN_INFO_ID,
              ORIGINAL_COLLECTION_EVENT_ID,PARENT_SPECIMEN_ID,PROCESSING_EVENT_ID,
              SPECIMEN_TYPE_ID,TOP_SPECIMEN_ID
              FROM specimen;

CREATE TABLE specimen_position_audit (
    ID INT(11) NOT NULL,
    REVISION INT(11) NOT NULL,
    REVISION_TYPE TINYINT(4) NULL DEFAULT NULL,
    END_REVISION INT(11) NULL DEFAULT NULL,
    POSITION_STRING VARCHAR(255) CHARACTER SET latin1 COLLATE latin1_general_cs NULL DEFAULT NULL,
    CONTAINER_ID INT(11) NULL DEFAULT NULL,
    CONTAINER_TYPE_ID INT(11) NULL DEFAULT NULL,
    SPECIMEN_ID INT(11) NULL DEFAULT NULL,
    SPECIMEN_TYPE_ID INT(11) NULL DEFAULT NULL,
    INDEX FK1A094F5CE4714145 (END_REVISION),
    INDEX FK1A094F5C6F00D261 (REVISION),
    PRIMARY KEY (ID, REVISION)
) ENGINE=InnoDB COLLATE=latin1_general_cs;

ALTER TABLE specimen_position_audit
      ADD CONSTRAINT FK1A094F5C6F00D261 FOREIGN KEY (REVISION)
          REFERENCES revision (ID) ON UPDATE NO ACTION ON DELETE NO ACTION,
      ADD CONSTRAINT FK1A094F5CE4714145 FOREIGN KEY (END_REVISION)
          REFERENCES revision (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

INSERT INTO specimen_position_audit (id,revision,revision_type,
    POSITION_STRING,CONTAINER_ID,CONTAINER_TYPE_ID,SPECIMEN_ID,SPECIMEN_TYPE_ID)
    SELECT id,0,0,POSITION_STRING,CONTAINER_ID,CONTAINER_TYPE_ID,SPECIMEN_ID,SPECIMEN_TYPE_ID
    FROM specimen_position;

