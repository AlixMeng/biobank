SET FOREIGN_KEY_CHECKS = 0;

#
# DDL START
#

DROP TABLE IF EXISTS  site_pv_attr;

CREATE TABLE `global_pv_attr` (
  `ID` int(11) NOT NULL,
  `LABEL` varchar(50) DEFAULT NULL,
  `PV_ATTR_TYPE_ID` int(11) NOT NULL,
  PRIMARY KEY (`ID`),
  KEY `FKBEF71B922496A267` (`PV_ATTR_TYPE_ID`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;

INSERT INTO `global_pv_attr` (ID, LABEL, PV_ATTR_TYPE_ID) VALUES
(1,"PBMC Count (x10^6)",1),
(2,"Worksheet",2),
(3,"Consent",5),
(4,"Phlebotomist",2),
(5,"Visit Type",4),
(6,"Biopsy Length",1);

ALTER TABLE study_pv_attr
      ADD `REQUIRED` bit(1) NULL DEFAULT NULL COMMENT '' AFTER PERMISSIBLE;

CREATE TABLE site_study (
    STUDY_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    SITE_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    PRIMARY KEY (SITE_ID, STUDY_ID),
    INDEX FK7A197EB1F2A2464F (STUDY_ID),
    INDEX FK7A197EB13F52C885 (SITE_ID)
);

INSERT INTO site_study (STUDY_ID, SITE_ID)
SELECT DISTINCT id, site_id FROM study;

ALTER TABLE activity_status
    MODIFY NAME varchar(50) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    activity_status.NAME changed from varchar(255) NULL DEFAULT NULL COMMENT '' to varchar(50) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE aliquot
    ADD INDEX FKF4502987C449A4 (ACTIVITY_STATUS_ID);


ALTER TABLE contact
    MODIFY NAME varchar(100) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    contact.NAME changed from varchar(255) NULL DEFAULT NULL COMMENT '' to varchar(100) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE container
    MODIFY LABEL varchar(255) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    container.LABEL changed from varchar(50) NULL DEFAULT NULL COMMENT '' to varchar(255) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE container_labeling_scheme
    MODIFY NAME varchar(50) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    container_labeling_scheme.NAME changed from varchar(255) NULL DEFAULT NULL COMMENT '' to varchar(50) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

DROP TABLE log_message;

DROP TABLE object_attribute;

DROP TABLE objectattributes;

ALTER TABLE pv_attr
    MODIFY VALUE varchar(255) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    pv_attr.VALUE changed from text NULL DEFAULT NULL COMMENT '' to varchar(255) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE pv_attr_type
    MODIFY NAME varchar(50) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    pv_attr_type.NAME changed from varchar(255) NULL DEFAULT NULL COMMENT '' to varchar(50) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE sample_type
    MODIFY NAME varchar(100) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    sample_type.NAME changed from varchar(255) NULL DEFAULT NULL COMMENT '' to varchar(100) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE shipment
    ADD SITE_ID int(11) NOT NULL DEFAULT 0 COMMENT '' AFTER BOX_NUMBER,
    ADD INDEX FKFDF619A3F52C885 (SITE_ID);

UPDATE shipment set SITE_ID=(SELECT id FROM site WHERE NAME_SHORT='CBSR');


ALTER TABLE source_vessel
    MODIFY NAME varchar(100) NULL DEFAULT NULL COMMENT '';
#
#  Fieldformat of
#    source_vessel.NAME changed from varchar(255) NULL DEFAULT NULL COMMENT '' to varchar(100) NULL DEFAULT NULL COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE study
    DROP SITE_ID,
    DROP INDEX FK4B915A93F52C885;


ALTER TABLE study_source_vessel
    MODIFY ID int(11) NOT NULL DEFAULT 0 COMMENT '';
#
#  Fieldformat of
#    study_source_vessel.ID changed from int(11) NOT NULL DEFAULT 0 COMMENT '' auto_increment to int(11) NOT NULL DEFAULT 0 COMMENT ''.
#  Possibly data modifications needed!
#

ALTER TABLE container_labeling_scheme
      ADD `MAX_ROWS` int(11) NULL DEFAULT NULL COMMENT '' AFTER NAME,
      ADD `MAX_COLS` int(11) NULL DEFAULT NULL COMMENT '' AFTER MAX_ROWS,
      ADD `MAX_CAPACITY` int(11) NULL DEFAULT NULL COMMENT '' AFTER MAX_COLS;

UPDATE container_labeling_scheme set max_rows=16,max_cols=24,max_capacity=384 where id=1;
UPDATE container_labeling_scheme set max_capacity=576 where id=2;
UPDATE container_labeling_scheme set max_capacity=99 where id=3;
UPDATE container_labeling_scheme set max_rows=2,max_cols=2,max_capacity=4 where id=4;

CREATE TABLE abstract_container (
    ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    DISCRIMINATOR varchar(255) NOT NULL DEFAULT '' COMMENT '' COLLATE latin1_swedish_ci,
    PRODUCT_BARCODE varchar(255) NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    COMMENT text NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    ACTIVITY_STATUS_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    CONTAINER_TYPE_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    LABEL varchar(255) NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    TEMPERATURE double NULL DEFAULT NULL COMMENT '',
    POSITION_ID int(11) NULL DEFAULT NULL COMMENT '',
    SITE_ID int(11) NULL DEFAULT NULL COMMENT '',
    SHIPMENT_ID int(11) NULL DEFAULT NULL COMMENT '',
    PRIMARY KEY (ID),
    UNIQUE POSITION_ID (POSITION_ID),
    INDEX FK4ED1F484223DE9BF (SHIPMENT_ID),
    INDEX FK4ED1F484C449A4 (ACTIVITY_STATUS_ID),
    INDEX FK4ED1F484AC528270 (POSITION_ID),
    INDEX FK4ED1F484B3E77A12 (CONTAINER_TYPE_ID),
    INDEX FK4ED1F4843F52C885 (SITE_ID)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

CREATE TABLE abstract_shipment (
    ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    DISCRIMINATOR varchar(255) NOT NULL DEFAULT '' COMMENT '' COLLATE latin1_swedish_ci,
    DATE_RECEIVED datetime NULL DEFAULT NULL COMMENT '',
    COMMENT text NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    WAYBILL varchar(255) NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    DATE_SHIPPED datetime NULL DEFAULT NULL COMMENT '',
    BOX_NUMBER varchar(255) NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    SHIPPING_METHOD_ID int(11) NULL DEFAULT NULL COMMENT '',
    SITE_ID int(11) NULL DEFAULT NULL COMMENT '',
    CLINIC_ID int(11) NULL DEFAULT NULL COMMENT '',
    DISPATCH_RECEIVER_ID int(11) NULL DEFAULT NULL COMMENT '',
    DISPATCH_SENDER_ID int(11) NULL DEFAULT NULL COMMENT '',
    PRIMARY KEY (ID),
    INDEX FK70F1B917FB659898 (DISPATCH_RECEIVER_ID),
    INDEX FK70F1B917DCA49682 (SHIPPING_METHOD_ID),
    INDEX FK70F1B917D84ED52 (DISPATCH_SENDER_ID),
    INDEX FK70F1B91757F87A25 (CLINIC_ID),
    INDEX FK70F1B9173F52C885 (SITE_ID),
    INDEX DATE_RECV_IDX (DATE_RECEIVED),
    INDEX WAYBILL_IDX (WAYBILL)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

CREATE TABLE clinic_shipment_patient (
    PATIENT_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    CLINIC_SHIPMENT_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    PRIMARY KEY (CLINIC_SHIPMENT_ID, PATIENT_ID),
    INDEX FKF4B18BB7E5B2B216 (CLINIC_SHIPMENT_ID),
    INDEX FKF4B18BB7B563F38F (PATIENT_ID)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

CREATE TABLE dispatch_info (
    ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    STUDY_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    FROM_SITE_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    PRIMARY KEY (ID),
    INDEX FK3D4D9D53377D3CF0 (FROM_SITE_ID),
    INDEX FK3D4D9D53F2A2464F (STUDY_ID)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

CREATE TABLE dispatch_info_site (
    SITE_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    DISPATCH_INFO_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    PRIMARY KEY (DISPATCH_INFO_ID, SITE_ID),
    INDEX FK86B04EB33F52C885 (SITE_ID),
    INDEX FK86B04EB3A927DCFA (DISPATCH_INFO_ID)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

CREATE TABLE dispatch_position (
    ABSTRACT_POSITION_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    CONTAINER_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    ALIQUOT_ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    PRIMARY KEY (ABSTRACT_POSITION_ID),
    INDEX FK99D8EF4EF32D3A6A (ABSTRACT_POSITION_ID),
    INDEX FK99D8EF4E898584F (ALIQUOT_ID),
    INDEX FK99D8EF4E68F34875 (CONTAINER_ID)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

CREATE TABLE notification (
    ID int(11) NOT NULL DEFAULT 0 COMMENT '',
    DATE_SENT datetime NULL DEFAULT NULL COMMENT '',
    MESSAGE text NULL DEFAULT NULL COMMENT '' COLLATE latin1_swedish_ci,
    HAS_READ bit(1) NULL DEFAULT NULL COMMENT '',
    SITE_ID int(11) NULL DEFAULT NULL COMMENT '',
    PRIMARY KEY (ID),
    INDEX FKAD9970EB3F52C885 (SITE_ID)
) DEFAULT CHARSET=latin1 COLLATE=latin1_swedish_ci;

ALTER TABLE clinic
    DROP SITE_ID,
    DROP INDEX FK76A608E83F52C885;


DROP TABLE container;

ALTER TABLE container_labeling_scheme
    ADD MAX_ROWS int(11) NULL DEFAULT NULL COMMENT '' AFTER NAME,
    ADD MAX_COLS int(11) NULL DEFAULT NULL COMMENT '' AFTER MAX_ROWS,
    ADD MAX_CAPACITY int(11) NULL DEFAULT NULL COMMENT '' AFTER MAX_COLS;


ALTER TABLE container_path
    DROP INDEX PATH_IDC,
    ADD INDEX PATH_IDX (PATH);


ALTER TABLE patient_visit
    ADD CLINIC_SHIPMENT_ID int(11) NOT NULL DEFAULT 0 COMMENT '' AFTER PATIENT_ID,
    DROP SHIPMENT_ID,
    DROP INDEX FKA09CAF51B1D3625,
    ADD INDEX FKA09CAF51E5B2B216 (CLINIC_SHIPMENT_ID);


DROP TABLE shipment;

DROP TABLE shipment_patient;

#
# DDL END
#

SET FOREIGN_KEY_CHECKS = 1;

